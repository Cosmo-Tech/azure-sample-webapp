# Dataset overview configuration

In the dataset manager view, the main panel displays an overview of the currently selected dataset. By default, its
content will be empty, but this can be changed by configuring, in the **workspace description**, how the webapp should
interpret the content of the dataset to **show KPIs** and **preview the dataset content**.

This description is usually defined in a file (e.g. _Workspace.yaml_), and this file is used to create or patch a
workspace with the Cosmo Tech API. In the workspace description file, the entries configuring the dataset overview are
regrouped in `additionalData.webapp.datasetManager`.

The configuration contains three parts:

- a list of **database queries** that will be run to retrieve data from the dataset
- some **KPI cards**, representing macro indicators of the dataset content, and displayed as small cards in the dataset
  overview
- some **categories**, displayed below the KPI cards, that regroup more detailed insights for the different types of
  elements inside the dataset

_Note: since v7.0.0, the workspace configuration key previously named `graphIndicators` has been renamed to `kpiCards`._

## Queries

When dataset resources are created with the Cosmo Tech API (e.g. from the dataset manager), they will usually contain
_**dataset parts**_, that can be of type `File` or `DB`. The webapp does not support preview mechanisms for the `File`
type, but for the `DB` type, the API can be used to run **SQL-like queries to retrieve data from the dataset**.
For each element displayed in the dataset overview (KPI cards, categories, preview tables), there must be
**a query defined to extract data from a `DB` dataset part**.

Configuration for these queries must be defined **in the workspace**, in `additionalData.webapp.datasetManager.queries`.
This value must be an **array of objects**, each representing a query, with the following fields:

- `id`: a unique identifier string for this query
- `datasetPartName`: the name of the `DB` dataset part to query
- `options`: the options to send to the dataset endpoint `/query` of the Cosmo Tech API (please refer to the
  documentation of the Cosmo Tech API for the full list of options)

The Cosmo Tech API returns the query results as CSV rows. Each query can thus return one or several columns,
**whose names are generated by the API** based on the query options.

The query examples below illustrate how to count the elements in two dataset parts.

<details>
<summary>JSON example</summary>

```json
{
  "additionalData": {
    "webapp": {
      "datasetManager": {
        "queries": [
          {
            "id": "bar_count_query",
            "datasetPartName": "bars",
            "options": { "counts": "id" }
          },
          {
            "id": "customer_count_query",
            "datasetPartName": "customers",
            "options": { "counts": "id" }
          }
        ]
      }
    }
  }
}
```

</details>

<details>
<summary>YAML example</summary>

```yaml
additionalData:
  webapp:
    datasetManager:
      queries:
        - id: bar_count_query
          datasetPartName: bars
          options:
            counts: id
        - id: customer_count_query
          datasetPartName: customers
          options:
            counts: id
```

</details>

### Query examples

A query can return multiple columns:

```json
{
  "id": "customer_table",
  "datasetPartName": "customers",
  "options": {
    "selects": "id,Satisfaction,SurroundingSatisfaction,Thirsty"
  }
}
```

A query can compute multiple indicators at once on a given table

```json
{
  "id": "bars",
  "datasetPartName": "bars",
  "options": {
    "avgs": "Stock,NbWaiters",
    "counts": "id",
    "mins": "NbWaiters",
    "maxs": "NbWaiters"
  }
}
```

## KPI cards

Configuration for the KPI cards must be defined in `additionalData.webapp.datasetManager.kpiCards`. This value must be
an **array of objects**, each item representing one KPI card, and containing the following properties:

- `id`: a unique identifier string for this KPI card
- `name`: an object with translations of the KPI name
- `queryId`: the identifier of the _query_ whose results contain the KPI value (see section [Queries](#queries) above)

<details>
<summary>JSON example</summary>

```json
{
  "additionalData": {
    "webapp": {
      "datasetManager": {
        "kpiCards": [
          {
            "id": "bars",
            "name": { "en": "Pubs", "fr": "Bars" },
            "queryId": "bar_count_query"
          },
          {
            "id": "customer_count",
            "name": { "en": "Customers", "fr": "Clients" },
            "queryId": "customer_count_query"
          }
        ]
      }
    }
  }
}
```

</details>

<details>
<summary>YAML example</summary>

```yaml
additionalData:
  webapp:
    datasetManager:
      kpiCards:
        - id: bars
          name:
            en: Pubs
            fr: Bars
          queryId: bar_count_query
        - id: customer_count
          name:
            en: Customers
            fr: Clients
          queryId: customer_count_query
```

</details>

## Categories

Configuration for the categories must be defined in `additionalData.webapp.datasetManager.categories`. This value must
be an **array of objects**, with each object representing a category (usually one table in the dataset) with the
following fields:

- `id`: a unique identifier string for this category
- `name`: an object with translations of the category name
- `type` _(optional)_: a string with one of the values `"entity"` or `"relationship"` (leave to `null` to hide this
  information)
- `description` _(optional)_: an object with translations of the category description
- `kpis` _(optional)_: an array of objects to represent key indicators of the category; each KPI object is defined with
  the fields:
  - `id`: a unique identifier string for this indicator
  - `name`: an object with translations of the indicator name
  - `queryId`: the identifier of the _query_ whose results contain the indicator (see section [Queries](#queries) above)
- `attributes` _(optional)_: an array of string values, to display the attributes of the category
- `previewTable` _(optional)_: configuration of a table displaying the dataset content

<details>
<summary>JSON example</summary>

```json
{
  "additionalData": {
    "webapp": {
      "datasetManager": {
        "categories": [
          {
            "name": { "en": "Bars", "fr": "Bars" },
            "description": {
              "en": "Bars are compound entities in the Brewery model. They are responsible of the stock management and the number of waiters. An entity of type Bar is the parent entity of Customers inside this bar.",
              "fr": "Les bars sont des entités composées du modèle Brewery. Ils sont responsables de la gestion du stock et du nombre de serveurs.\nUne entité de type Bar est l\"entité parente des entités Customer présentes dans ce bar."
            },
            "attributes": ["NbWaiters", "RestockQty", "Stock"],
            "id": "bars",
            "type": "entity",
            "kpis": [
              {
                "id": "avg_Stock",
                "name": { "en": "Average stock", "fr": "Moyenne stock" },
                "queryId": "bars"
              },
              {
                "id": "avg_NbWaiters",
                "name": { "en": "Average waiters", "fr": "Moyenne serveurs" },
                "queryId": "bars"
              },
              {
                "id": "min_NbWaiters",
                "name": { "en": "Min. waiters", "fr": "Min. serveurs" },
                "queryId": "bars"
              },
              {
                "id": "max_NbWaiters",
                "name": { "en": "Max. waiters", "fr": "Max. serveurs" },
                "queryId": "bars"
              }
            ]
          }
        ]
      }
    }
  }
}
```

</details>

<details>
<summary>YAML example</summary>

```yaml
additionalData:
  webapp:
    datasetManager:
      categories:
        name:
          en: Bars
          fr: Bars
        description:
          en: >-
            Bars are compound entities in the Brewery model. They are responsible of
            the stock management and the number of waiters. An entity of type Bar is
            the parent entity of Customers inside this bar.
          fr: >-
            Les bars sont des entités composées du modèle Brewery. Ils sont
            responsables de la gestion du stock et du nombre de serveurs.

            Une entité de type Bar est l"entité parente des entités Customer
            présentes dans ce bar.
        attributes:
          - NbWaiters
          - RestockQty
          - Stock
        id: bars
        type: entity
        kpis:
          - id: avg_Stock
            name:
              en: Average stock
              fr: Moyenne stock
            queryId: bars
          - id: avg_NbWaiters
            name:
              en: Average waiters
              fr: Moyenne serveurs
            queryId: bars
          - id: min_NbWaiters
            name:
              en: Min. waiters
              fr: Min. serveurs
            queryId: bars
          - id: max_NbWaiters
            name:
              en: Max. waiters
              fr: Max. serveurs
            queryId: bars
```

</details>

## Preview tables (a.k.a. category details)

In category accordions, you can open a "_category details_" dialog that can display the content of the DB dataset part
in a table. These tables are filled with the same query mechanism as the KPI cards and category indicators, and they are
**read-only** (end-users cannot modify the dataset content).

The table content can be configured for each category by setting the key
`additionalData.webapp.datasetManager.categories.[category].previewTable`. Its value must be an **object** with the
following fields:

- `columns`: an array describing **the expected columns of the table**
  (see [Columns definition](scenarioParametersConfiguration.md#columns-definition)).
- `queryId`: the identifier of the _query_ whose results will be shown in the table
  (see section [Queries](#queries) above)

_Note: since v7.0.0, the property `resultKey` is no longer necessary; the id of the table columns must match the names of the column returned by the query_

Here are examples of categories with preview tables;

<details>
<summary>JSON example</summary>

```json
{
  "additionalData": {
    "webapp": {
      "datasetManager": {
        "categories": [
          {
            "id": "bars",
            "name": { "en": "Bars", "fr": "Bars" },
            "previewTable": {
              "columns": [
                {
                  "headerName": "Number of waiters",
                  "field": "NbWaiters",
                  "type": ["int"]
                },
                {
                  "headerName": "Restock quantity",
                  "field": "RestockQty",
                  "type": ["int"]
                },
                {
                  "headerName": "Stock",
                  "field": "Stock",
                  "type": ["int"]
                }
              ],
              "queryId": "bar_table"
            }
          }
        ],
        "queries": [
          {
            "options": {
              "selects": "NbWaiters,RestockQty,Stock"
            },
            "datasetPartName": "bars",
            "id": "bar_table"
          }
        ]
      }
    }
  }
}
```

</details>

<details>
<summary>YAML example</summary>

```yaml
additionalData:
  webapp:
    datasetManager:
      categories:
        - id: bars
          name:
            en: Bars
            fr: Bars
          previewTable:
            columns:
              - headerName: Number of waiters
                field: NbWaiters
                type:
                  - int
              - headerName: Restock quantity
                field: RestockQty
                type:
                  - int
              - headerName: Stock
                field: Stock
                type:
                  - int
            queryId: bar_table
      queries:
        - options:
            selects: 'NbWaiters,RestockQty,Stock'
          datasetPartName: bars
          id: bar_table
```

</details>
